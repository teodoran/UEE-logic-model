<!DOCTYPE HTML>
<head>
	<script type="text/javascript" src="https://github.com/jashkenas/coffee-script/raw/master/extras/coffee-script.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
	<script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
	<script type="text/javascript" src="KeyboardController.js"></script>
	<link rel="stylesheet" type="text/css" href="escapeStyle.css" />
	<title>Escape</title>
	<script type="text/coffeescript">
		makeEntity = (x, y, speed, player) ->
			entity = 
				x: x
				y: y
				speed: speed
				
		winHeight = window.innerHeight
		winWidth = window.innerWidth
		score = 0
		enemySpawnRate = 50
		player = makeEntity winWidth*0.5, winHeight*0.5, 5
		enemies = []
		run = false
		
		spawnEnemy = (enemies) ->
			newEnemy = makeEntity 0, 0, score
			enemies[enemies.length] = setRandomEnemyStart newEnemy 
			
		setRandomEnemyStart = (enemy) ->
			side = Math.floor(Math.random()*4)
			switch side
				when 0
					enemy.x = -100
					enemy.y = Math.random()*winHeight
				when 1 
					enemy.x = Math.random()*winWidth
					enemy.y = -100
				when 2 
					enemy.x = 100 + winWidth
					enemy.y = Math.random()*winHeight
				when 3 
					enemy.x = Math.random()*winWidth
					enemy.y = 100 + winHeight
			return enemy
	
		movePlayer = (keyCode) ->
			switch keyCode
				when 37 then moveEntity player, -player.speed, 0
				when 38 then moveEntity player, 0, -player.speed
				when 39 then moveEntity player, player.speed, 0
				when 40 then moveEntity player, 0, player.speed
				
		moveEnemies = (enemies) ->
			for enemy in enemies
				moveEntity enemy, (player.x-enemy.x)*0.07, (player.y-enemy.y)*0.07			
		
		moveEntity = (entity, diffX, diffY) ->
			entity.x += diffX
			entity.y += diffY
		
		initialize = (enemies) ->
			spawnEnemy enemies, winWidth, winHeight
			run = true
			
		drawScreen = (board) ->
			do board.children().remove
			for enemy in enemies
				board.append "<div class=\"enemy\" style=\"left:"+enemy.x+"px; top:"+enemy.y+"px;\">"	
			board.append "<div class=\"player\" style=\"left:"+player.x+"px; top:"+player.y+"px;\">"

		drawHighscore = (board) ->
			board.append "<form action=\"highscoreRegister.jsp\" method=\"post\" style=\"left:"+(winWidth*0.5-150)+"px; top:"+(winHeight*0.5-100)+"px;\">
							<p><h2>Add to highscore</h2></p>
							<p>Score: "+score+"</p>
							<p>Name: <input type=\"text\" name=\"navn\" value=\"\"><input type=\"submit\" value=\"apply\"></p>
							<input id=\"scoreValue\" name=\"scoreValue\" type=\"hidden\" value=\""+score+"\">
							<p><a href=\"index.htm\">Play again</a> <a href=\"highscore.jsp\">View highscore</a></p>
						</form>"

		update = (enemies) ->
			#moveEnemies enemies
			KeyboardController { 
				37: (-> movePlayer 37), 
				38: (-> movePlayer 38), 
				39: (-> movePlayer 39), 
				40: (-> movePlayer 40) }, 24

		hasCollided = (enemy, player) ->
			diffX = (player.x-enemy.x)
			diffY = (player.y-enemy.y)
			hasNotCollidedX = diffX*diffX <= 110
			hasNotCollidedY = diffY*diffY <= 110
			hasNotCollidedX and hasNotCollidedY
			
		playerHitWall = (player) ->
			player.x <= 0 or player.y <= 0 or player.x >= winWidth or player.y >= winHeight

		checkCollisions = (enemies, player) ->
			if playerHitWall player
				run = false
			for enemy in enemies
				if hasCollided player, enemy
					run = false
				for otherEnemy in enemies
					if (hasCollided enemy, otherEnemy) and (enemy.speed isnt otherEnemy.speed)
						enemy = setRandomEnemyStart enemy
						otherEnemy = setRandomEnemyStart otherEnemy			
						
		gameLoop = (board) ->
			$("#score").text score += 1
			#update enemies
			if score >= 300
				enemySpawnRate = 200
			if (score % enemySpawnRate) is 0
				spawnEnemy enemies, winWidth, winHeight
			checkCollisions enemies, player
			moveEnemies enemies
			drawScreen board
			if run
				setTimeout (-> gameLoop board), 24
			else
				drawHighscore board
				$("#endText").text "Game over"

		$ ->
			initialize enemies, run
			update enemies
			gameLoop $("#board")		
	      
	</script>
</head>

<body>
	<span id="score"></span>
	<span id="endText"></span>
	<div id="board"></div>
</body>