<!DOCTYPE HTML>
<head>
	<script type="text/javascript" src="https://github.com/jashkenas/coffee-script/raw/master/extras/coffee-script.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
	<script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
	<script type="text/javascript" src="keyboard-controller.js"></script>
	<link rel="stylesheet" type="text/css" href="model-style.css" />
	<title>UEE model test</title>
	<script type="text/coffeescript">
		makeEntity = (x, y, speed, player) ->
			entity = 
				x: x
				y: y
				speed: speed
				heading: Math.PI/2
				rudderAngle: 0.0
				
		winHeight = window.innerHeight
		winWidth = window.innerWidth
		score = 0
		player = makeEntity winWidth*0.5, winHeight*0.5, 4
		run = false

		movePlayer = (keyCode) ->
			turnAngle = Math.PI/32
			switch keyCode
				when 37 then turnEntity player, turnAngle
				when 39 then turnEntity player, -turnAngle

		turnRudder = (keyCode) ->
			turnAngle = Math.PI/128
			maxTurnAngle = Math.PI/32
			switch keyCode
				when 37 then if player.rudderAngle + turnAngle < maxTurnAngle 
								player.rudderAngle += turnAngle
				when 39 then if player.rudderAngle - turnAngle > -maxTurnAngle
								player.rudderAngle -= turnAngle
		
		turnEntity = (entity, rudderAngle) ->
			entity.heading += rudderAngle
			entity.x += entity.speed*Math.cos(entity.heading)
			entity.y += entity.speed*Math.sin(entity.heading)

		moveEntity = (entity, rudderAngle) ->
			entity.heading += rudderAngle
			entity.x += entity.speed*Math.cos(entity.heading)
			entity.y += entity.speed*Math.sin(entity.heading)
			
		moveTorpedo = (entity) ->
			entity.heading += entity.rudderAngle
			entity.x += entity.speed*Math.cos(entity.heading)
			entity.y += entity.speed*Math.sin(entity.heading)

		drawScreen = (board) ->
			do board.children().remove
			board.append "<div class=\"player\" style=\"left:"+player.x+"px; top:"+player.y+"px;\">"	
						
		gameLoop = (board) ->
			$("#score").text score += 1
			moveTorpedo player
			drawScreen board
			if run
				setTimeout (-> gameLoop board), 24

		$ ->
			run = true
			KeyboardController { 
				37: (-> turnRudder 37), 
				39: (-> turnRudder 39)}, 24
			gameLoop $("#board")		
	      
	</script>
</head>

<body>
	<span id="score"></span>
	<span id="endText"></span>
	<div id="board"></div>
</body>